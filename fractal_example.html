<!DOCTYPE html>
<html>
	<head>
		<title>metaworker examples - mandelbrot fractal</title>
	</head>
	<body style="background-color:#fff">
		<h1>metaworker examples - mandelbrot fractal</h1>
		<pre id="counter"></pre>
		<canvas id="canv" width="512" height="512" style="border:7px solid black;"></canvas>
	</body>
	<script type="text/javascript" src="metaworker_lib.js"></script>
	<script type="text/javascript">

		var mandelRow = function(work) {
			var results = [];
			for(var w=0;w<work.length;w++){
				var config = work[w];

				var x = config.x;
				var y = config.y;
				var width = config.width;
				var maxiterations = config.maxiterations;
				var dx = config.dx;

				var pixels = [];
				for(var i = 0; i < width; i++){
					var a = x;
					var b = y;
					var n = 0;
					while (n < maxiterations){
						var aa = a * a;
						var bb = b * b;
						var twoab = 2 * a * b;
						a = aa - bb + x;
						b = twoab + y;
						if (aa + bb > 16){
							break;
						}
						n++;
					}
					if(n==maxiterations){
						pixels.push([0,0,0]);
					} else {
						// pixels.push([Math.round(n * 16 % 255), Math.round(n * 16 % 255), Math.round(n * 16 % 255)]);
						var r = Math.floor(n * 1600 % 255);
						var g = Math.floor(n * 800 % 255);
						var b = Math.floor(n * 200 % 255);
						pixels.push([r,g,b]);
					}
					x += dx;
				}
				results.push({
					pixels:pixels,
					rowIndex:config.j
				});
			}
			return results;
		};
		
		var drawRows = function(rows){
			var canvas = document.getElementById('canv');
			if (canvas.getContext){
				var ctx = canvas.getContext('2d');
				for(var i=0;i<rows.length;i++){
					var runLength = 0;
					var row = rows[i];
					var y = row.rowIndex;
					var pixels = row.pixels;
					var plen = pixels.length;
					for(var x=0;x<plen;x++){
						ctx.fillStyle = 'rgb(' + pixels[x][0] + ',' + pixels[x][1] + ',' + pixels[x][2] + ')';
						while((x+runLength+1)<plen && 
							(
								pixels[x+runLength+1][0] == pixels[x][0] &&
								pixels[x+runLength+1][1] == pixels[x][1] &&
								pixels[x+runLength+1][2] == pixels[x][2]
							)
						){
							runLength++;
						}
						ctx.fillRect (x, y, 1 + runLength, 1);
						// skip ahead
						if(runLength>0){
							x = x + runLength;
							runLength = 0;
							if(x>=plen){
								return;
							}
						}
					}
				}
			}
		};


		var rows = [];

		var width = 512;
		var height = 512;
		var xmin = -2.45;
		var ymin = -2;
		var xmax = width;
		var ymax = height;
		var wh = 4;
		var maxiterations = 30;
		var xmax = xmin + wh;
		var ymax = ymin + wh;
		var dx = (xmax - ymin) / width;
		var dy = (ymax - ymin) / height;
		var work = [];

		//
		// Create some work
		//
		var y = ymin;
		for(var j = 0; j < height; j++){
			work.push({
				width:width,
				maxiterations:maxiterations,
				x:xmin,
				y:y,
				dx:dx,
				j:j
			});
			y = y + dy;
		}
		
		var counter = 0;
		setInterval(function(){
			document.getElementById("counter").innerHTML = (new Date()).toString();
			counter++;
		},1000);
		
		var received_work_count = 0;
		for(var i=0;i<work.length;i++){
			metaworker({
				mapper: mandelRow,
				onIntermediateResults: function(intermediate_results){
					var rd = new Date();
					var rstartTime = rd.getTime();
					for(var i=0;i<intermediate_results.length;i++){
						drawRows(intermediate_results[i]);
					}
					var rd2 = new Date();
					var rendTime = rd2.getTime();
					console.log("Renderer took ",((rendTime-rstartTime)),"ms to render ",intermediate_results.length," rows");
				},
				reducer: function(existing_results, intermediate_results){
					console.log("reducer input is of length",intermediate_results.length);
					
					//
					// reducer receives work results from workers and just concatenates them
					// intermediate results looks like this:
					//
					// [[rowresult,rowresult,rowresult], [rowresult,rowresult,rowresult], ..]
					//
					// we want to output:
					//
					// [rowresult,rowresult,rowresult, rowresult,rowresult,rowresult, ..]
					//
					// as if the entire process had been done by a single thread
					//

					var d = new Date();
					var startTime = d.getTime();
					for(var i=0;i<intermediate_results.length;i++){
						if(intermediate_results[i].length > 0){
							for(var ir=0;ir<intermediate_results[i].length;ir++){
								existing_results.push(intermediate_results[i][ir]);
							}
						}
					}
					var d2 = new Date();
					var endTime = d2.getTime();
					console.log("non-canvas reduction phase took ",(endTime-startTime),"ms to run");

					return existing_results;
				},
				parallel: true,
				work: work,
				callback:function(result){
					// result is a mandelbrot
					console.log("Callback received resulting mandelbrot rendering ",result.length," rows in length.");
				}
			});
		}		


	</script>
</html>